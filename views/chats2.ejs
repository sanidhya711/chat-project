<!DOCTYPE html>
    <head>
      <meta charset="UTF-8">
    <title>chats <%= to %></title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="icon" href="/favicon.png">
    <link rel="stylesheet" href="/three-dots.min.css">
    <link rel="stylesheet" href="/chats.css">
    <script src="https://use.fontawesome.com/3eec3d21d8.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js"></script>
    </head>
    <body onscroll="scrolled()" style="background-color:<%= secondryColor %>;">    
      <div class="backToHome"><a href="/"><img src="https://img.icons8.com/cotton/80/000000/circled-left-2.png"/></a></div>
      <div style="background-color: <%= primaryColor %>;" class="topBar">
        <div style="padding:5px;"  id="call" onclick="call()">
        <i style="color: green;" class="fa fa-phone fa-2x" aria-hidden="true"></i>
        </div>
        <div style="padding:5px;display: none;" id="answer">
          <i style="color: yellow;" class="fa fa-phone fa-2x" aria-hidden="true"></i>
        </div>
        <div style="padding:5px;display: none;" onclick="hangup()" id="hangup">
          <i style="color: red;" class="fa fa-phone fa-2x" aria-hidden="true"></i>
          <i style="color: red;position: relative;right: 15px;bottom: 15px;" class="fa fa-times" aria-hidden="true"></i>
        </div>
        <i onclick="showSettings()" class="fa fa-cog fa-3x" aria-hidden="true"></i>
        <h1><%= to %></h1>
        <img style="height: 60px;width: 60px;border-radius: 50%;margin-left: 30px;object-fit: cover;box-shadow: 0 0 10px #fff;" src="<%= toPfp %>">
      </div>
      <div id="videoGrid"></div>
      <div style="background-color: <%= primaryColor %>;" class="homeHolder">
      <% users.forEach(function(name){%>
          <% if(username!=name.username && name.username!=to){%>
              <a class="<>" href="/chats/<%=name.username%>"> 
                  <div class="eachUser <%= name.username %>">
                      <h1 class="bruhbruhbruh"><%=name.username%></h1>
                      <img style="height: 50px;width: 50px;border-radius: 50%;position: absolute;right: 15px;top: 27px;" src="<%= name.pfp %>">
                      <% if(name.unseen>0){ %>
                        <h1 class="notification" ><%= name.unseen %></h1>
                        <% } %>
                  </div>
              </a>
      <% } %>
      <%})%>
      </div>

      <div id="from" class="<%=from%>"></div>
      <div id="to" class="<%=to%>"></div>
      <div id="username" class="<%=username%>"></div>

       <div class="allMessagesAndNewMessagesHolder">

       <div class="allMessages">

        <div style="display: none;"  id="for_weird_arrow">
          <div id="gif_box_outer">
            <input autocomplete="off" placeholder="Search For GIFS" class="search_gif" type="search">
            <div id="gif_preview_holder">
              <div id="gifBox1"></div>
              <div id="gifBox2"></div>
            </div>
          </div>
        </div>

        <emoji-picker></emoji-picker>
        
      <% messages.slice().reverse().forEach(function(message){ %>
        <% if(message.from==username){var id = "green"}else{var id = "blue"} %>
        <% if(message.type==null){%>
        <% if(message.seen){var seen = "seen"}else{var seen = ""} %>
        <div id="<%= message.id %>" class="<%= id %> messagee <%= seen %>">
          <span class="messageTime"><%= message.time %></span>
          <% if(message.from==username){ %>
            <div class="notSelectable"><img loading="lazy"  onclick="deleteMessage(this)"   class="<%= message.id %>" src="https://img.icons8.com/material/24/000000/delete-trash.png"/></div>
            <% }else{ %>
              <br>
              <% } %>
            <h3><%=message.message%></h3>
              <% if(message.seen && message.from == username){ %>
              <h1 class="doubletick"><img loading="lazy" src="https://img.icons8.com/plasticine/30/000000/double-tick.png"/></h1>
                <% } %>
        </div>

        <% }else if(message.type=="image"){%>
         <div id="<%= message.id %>" class="imageHolder">
          <img loading="lazy" class="image<%= id %>"src="<%= message.message %>"/>
           <% if(message.from==username){ %>
            <div class="fileName" id="<%= message.name %>"></div>
           <div>
           <div style="position: relative;right: 2vw;" class="notSelectable" >
            <img loading="lazy" class="<%= message.id %>" onclick="deleteMessage(this)" src="https://img.icons8.com/material/24/000000/delete-trash.png"/>
          </div>
        </div>
        <% }%>
      </div>

        <%}else{%>
          <div id="<%= message.id %>">
            <div style="width: 100%;display: flex;justify-content: center;margin-bottom: 30px;">
              <video width="579" class="video<%= id %>" controls>
                <source src="<%= message.message %>" type="video/mp4">
              </video>
            
            <% if(message.from==username){ %>
              <div class="fileName" id="<%= message.name %>"></div>
            <div><div class="notSelectable"><img loading="lazy" onclick="deleteMessage(this)" class="<%= message.id %>" src="https://img.icons8.com/material/24/000000/delete-trash.png"/></div></div>
            <% }else{ %>
              <div style="width: 24px;"></div>
              <% } %>
          </div>
      </div>
          <% } %>
     <% }); %>

    <div id="typing" class="hidee"><h3><%= to %> is typing</h3><div class="dot-flashing"></div></div>
    </div>
    <div class="writeNewMessage">

      <!-- video -->
         <div style="position: relative;bottom: 7px;" class="file-upload">
          <label for="video-input">
            <img loading="lazy" src="https://img.icons8.com/dusk/55/000000/video.png"/>
          </label>
         <input onclick="hide_gif()" id="video-input" accept="video/mp4,video/x-m4v,video/*" type="file" />
        </div>   

        <i style="color: yellow;" class="fa fa-smile-o fa-3x" aria-hidden="true"></i>

       <!-- image -->
       <div style="position: relative;bottom: 15px;" class="file-upload">
        <label for="image-input">
          <img loading="lazy" src="https://img.icons8.com/plasticine/70/000000/image.png"/>
        </label>
        <input onclick="hide_gif()" id="image-input" accept="image/x-png,image/gif,image/jpeg" onclick="this.value=null" type="file" />
      </div> 

      <div style="position: relative;bottom: 3.5px;right: 7px;">
      <img loading="lazy" id="gif-input" width="58px" height="46.2px" src="https://img.icons8.com/ultraviolet/45/000000/gif.png"/>
    </div>

        <div style="width: 60%;">
          <input onclick="hide_gif()" id="msg" type="text" placeholder="Message <%= to %>" required oninput="typing()" autocomplete="off" />
        </div>
          <div>
            <button style="background-color: <%= primaryColor %>;" class="send"><img src="https://img.icons8.com/ios-glyphs/30/000000/filled-sent.png"/></button>
          </div>
     
    </div>

    <script>
      $("html, body").animate({ scrollTop: $(document).height()},0);
      window.onload = function(){
        // scroll down on load
        $("html, body").animate({ scrollTop: $(document).height()},0);
      };
    </script>
          <!-- javascript -->
           <script src="/chats.js"></script> 
           <script src="https://www.gstatic.com/firebasejs/7.17.2/firebase.js"></script>

<script>
  // Your web app's Firebase configuration
  var firebaseConfig = {
    apiKey: "AIzaSyCuWvo9j3jIFPUUI3q9BCpw_2ZDOz9UnJE",
    authDomain: "learning-data-bucket.firebaseapp.com",
    databaseURL: "https://learning-data-bucket.firebaseio.com",
    projectId: "learning-data-bucket",
    storageBucket: "learning-data-bucket.appspot.com",
    messagingSenderId: "1044574492967",
    appId: "1:1044574492967:web:1c88e6d23f3fbd1395b102",
    measurementId: "G-8ZV0F76E34"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();

  //get elements for image upload
  var fileSubmitImage = $("#image-input");
  var progressHolder = document.createElement("div");
  progressHolder.id="fileUploadProgressHolder";
  progressHolder.innerHTML='<progress id="fileUploadProgress" style="width: 40%;" value="0" max="100">0%</progress>';

  fileSubmitImage.on("change",function(e){
    var file = e.target.files[0];
    var storageRef = firebase.storage().ref("/"+file.name);
    var uploadTask = storageRef.put(file)
      $("#typing").before(progressHolder);
      $(window).scrollTop(document.querySelector(".allMessages").scrollHeight);
    var Uploadprogress = $("#fileUploadProgress");
      uploadTask.on('state_changed', function(snapshot){
    var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
    Uploadprogress.value=progress;
    },function(error){},
    function() {
    uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL){
      document.querySelector(".allMessages").removeChild(document.querySelector("#fileUploadProgressHolder"));
      newImage(downloadURL,file.name);
      
    });
    });
    });

      //get elements for uploading video
  var fileSubmitVideo = $("#video-input");

fileSubmitVideo.on("change",function(e){
  var file = e.target.files[0];
  var storageRef = firebase.storage().ref("/"+file.name);
  var uploadTask = storageRef.put(file)
  $("#typing").before(progressHolder);
  $(window).scrollTop(document.querySelector(".allMessages").scrollHeight);
  var Uploadprogress = document.querySelector("#fileUploadProgress");
    uploadTask.on('state_changed', function(snapshot){
  var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
  Uploadprogress.value=progress;
  },function(error){},
  function() {
    document.querySelector(".allMessages").removeChild(document.querySelector("#fileUploadProgressHolder"));
  uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL){
    newVideo(downloadURL,file.name);
  });
  });
  });

  // delete a file from firebase
  function deleteFileFromFirebase(fileName){
    if(!fileName.includes("tenor")){
      var deleteref = firebase.storage().ref("/"+fileName)
        // Delete the file from firebase
        deleteref.delete().then(function() {
        // File deleted successfully
        // console.log("successully deleted from firebase");
    }).catch(function(error) {
        // Uh-oh, an error occurred!
        console.log(error);
    });
    }
  }

</script>    
    </body>
